<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="k8s," />





  <link rel="alternate" href="/atom.xml" title="陈凡的个人站点" type="application/atom+xml" />






<meta name="description" content="集群环境说明服务器信息这里配置2Master 2个node, k8s-master01只做 Master, k8s-node01即是Master也是Node, k8s-node02单纯做Node。  集群详情 Kubernetes 1.9.1 Docker-17.03.1-ce Etcd-v3.2.14 Flannel">
<meta name="keywords" content="k8s">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes-1.9.1-HA生产环境实践">
<meta property="og:url" content="http://www.chenfanlinux.org/2018/04/06/Kubernetes-1-9-1-HA生产环境实践/index.html">
<meta property="og:site_name" content="陈凡的个人站点">
<meta property="og:description" content="集群环境说明服务器信息这里配置2Master 2个node, k8s-master01只做 Master, k8s-node01即是Master也是Node, k8s-node02单纯做Node。  集群详情 Kubernetes 1.9.1 Docker-17.03.1-ce Etcd-v3.2.14 Flanneld-v0.10.0 vxlan TLS 认证通信 RBAC 授权 Kublet">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://s1.ax1x.com/2018/04/02/9z62xH.png">
<meta property="og:image" content="https://s1.ax1x.com/2018/04/03/CpAs9s.png">
<meta property="og:updated_time" content="2018-04-08T08:20:58.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kubernetes-1.9.1-HA生产环境实践">
<meta name="twitter:description" content="集群环境说明服务器信息这里配置2Master 2个node, k8s-master01只做 Master, k8s-node01即是Master也是Node, k8s-node02单纯做Node。  集群详情 Kubernetes 1.9.1 Docker-17.03.1-ce Etcd-v3.2.14 Flanneld-v0.10.0 vxlan TLS 认证通信 RBAC 授权 Kublet">
<meta name="twitter:image" content="https://s1.ax1x.com/2018/04/02/9z62xH.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'X18Q8YOK7R',
      apiKey: '4cf6f4ea962b4c633859ca376c0d6ae9',
      indexName: 'chenfanlinux',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.chenfanlinux.org/2018/04/06/Kubernetes-1-9-1-HA生产环境实践/"/>





  <title>Kubernetes-1.9.1-HA生产环境实践 | 陈凡的个人站点</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?your-analytics-id";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  
 

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">陈凡的个人站点</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">chenfanlinux.org</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.chenfanlinux.org/2018/04/06/Kubernetes-1-9-1-HA生产环境实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="陈凡">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="陈凡的个人站点">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Kubernetes-1.9.1-HA生产环境实践</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-06T13:41:21+08:00">
                2018-04-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>

                
                
              
            </span>
          
  
          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/06/Kubernetes-1-9-1-HA生产环境实践/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2018/04/06/Kubernetes-1-9-1-HA生产环境实践/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv">本文总阅读量
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  7,158
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  39
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="集群环境说明"><a href="#集群环境说明" class="headerlink" title="集群环境说明"></a>集群环境说明</h2><h3 id="服务器信息"><a href="#服务器信息" class="headerlink" title="服务器信息"></a>服务器信息</h3><p>这里配置2Master 2个node, k8s-master01只做 Master, k8s-node01即是Master也是Node, k8s-node02单纯做Node。</p>
<p><img src="https://s1.ax1x.com/2018/04/02/9z62xH.png" alt="服务器信息"></p>
<h3 id="集群详情"><a href="#集群详情" class="headerlink" title="集群详情"></a>集群详情</h3><ul>
<li>Kubernetes 1.9.1</li>
<li>Docker-17.03.1-ce</li>
<li>Etcd-v3.2.14</li>
<li>Flanneld-v0.10.0 vxlan</li>
<li>TLS 认证通信</li>
<li>RBAC 授权</li>
<li>Kublet TLS BootStrapping</li>
<li>Coredns:1.0.4</li>
<li>Registry-2.6</li>
</ul>
<a id="more"></a>
<h3 id="网络环境说明"><a href="#网络环境说明" class="headerlink" title="网络环境说明"></a>网络环境说明</h3><ul>
<li>服务器网络（10.173.36.214/21）</li>
<li>Clutser网络（10.253.0.0/16)</li>
<li>Flannel网络（10.254.0.0/16）</li>
</ul>
<h3 id="集群拓扑图"><a href="#集群拓扑图" class="headerlink" title="集群拓扑图"></a>集群拓扑图</h3><p><img src="https://s1.ax1x.com/2018/04/03/CpAs9s.png" alt="集群拓扑图"></p>
<h2 id="集群环境初始化"><a href="#集群环境初始化" class="headerlink" title="集群环境初始化"></a>集群环境初始化</h2><table><tr><td bgcolor="#008000"> master和node </td></tr></table>

<h3 id="设置主机名-永久生效）"><a href="#设置主机名-永久生效）" class="headerlink" title="设置主机名(永久生效）"></a>设置主机名(永久生效）</h3><pre><code>$ hostnamectl --static set-hostname k8s-master01
$ hostnamectl --static set-hostname k8s-node01
$ hostnamectl --static set-hostname k8s-node02
</code></pre><h3 id="配置epel7-yum源"><a href="#配置epel7-yum源" class="headerlink" title="配置epel7 yum源"></a>配置epel7 yum源</h3><pre><code>$ yum install  epel-release
</code></pre><h3 id="配置ntp时间同步"><a href="#配置ntp时间同步" class="headerlink" title="配置ntp时间同步"></a>配置ntp时间同步</h3><pre><code>$ yum -y install ntp
$ vim /etc/ntp.conf
server time.pool.aliyun.com        # 向阿里云的ntp服务器进行校准
$ systemctl start ntpd
$ systemctl enable ntpd
</code></pre><h3 id="配置密钥对"><a href="#配置密钥对" class="headerlink" title="配置密钥对"></a>配置密钥对</h3><pre><code>$ ssh-keygen -t rsa -P &quot;&quot; -f /root/.ssh/id_rsa #  把生成的公钥拷贝到其他节点的 authorized_keys 即可
</code></pre><h3 id="修改-etc-hosts"><a href="#修改-etc-hosts" class="headerlink" title="修改/etc/hosts"></a>修改/etc/hosts</h3><pre><code>$ vim /etc/hosts
 10.173.36.214 k8s-master01
 10.173.36.215 k8s-node02
 10.173.36.216 k8s-node01
$ scp /etc/hosts root@10.173.36.216:/etc
$ scp /etc/hosts root@10.173.36.215:/etc
</code></pre><h3 id="打开路由转发"><a href="#打开路由转发" class="headerlink" title="打开路由转发"></a>打开路由转发</h3><pre><code>$ echo &quot;net.ipv4.ip_forward = 1&quot; &gt;&gt;/etc/sysctl.conf
$ sysctl -p
</code></pre><h3 id="关闭NetworkManager"><a href="#关闭NetworkManager" class="headerlink" title="关闭NetworkManager"></a>关闭NetworkManager</h3><pre><code>$ systemctl stop NetworkManager
$ systemctl disable NetworkManager # 此服务会接管nameserver,导致修改不成功
</code></pre><p><strong><em>这是网易云平台特有的配置，其他云平台可以忽略！</em></strong></p>
<h3 id="关闭-firewall"><a href="#关闭-firewall" class="headerlink" title="关闭 firewall"></a>关闭 firewall</h3><pre><code>$ systemctl stop firewalld
$ systemctl disable firewalld
</code></pre><h2 id="安装并配置Docker"><a href="#安装并配置Docker" class="headerlink" title="安装并配置Docker"></a>安装并配置Docker</h2><table><tr><td bgcolor="#008000"> master和node </td></tr></table>

<h3 id="安装yum管理工具并添加Docker官方源"><a href="#安装yum管理工具并添加Docker官方源" class="headerlink" title="安装yum管理工具并添加Docker官方源"></a>安装yum管理工具并添加Docker官方源</h3><pre><code>$ yum install -y yum-utils
$ yum-config-manager  --add-repo  https://download.docker.com/linux/centos/docker-ce.repo
$ yum makecache
</code></pre><h3 id="查看yum版本"><a href="#查看yum版本" class="headerlink" title="查看yum版本"></a>查看yum版本</h3><pre><code>$ yum list docker-ce.x86_64  --showduplicates |sort -r
</code></pre><h3 id="安装docker-ce的依赖-docker-ce-selinux"><a href="#安装docker-ce的依赖-docker-ce-selinux" class="headerlink" title="安装docker-ce的依赖 docker-ce-selinux"></a>安装docker-ce的依赖 docker-ce-selinux</h3><p>安装这个docker-ce-selinux，需要保持selinux的enforcing状态，安装完记得关闭。</p>
<pre><code>$ wget https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-selinux-17.03.1.ce-1.el7.centos.noarch.rpm
$ rpm -ivh docker-ce-selinux-17.03.1.ce-1.el7.centos.noarch.rpm
</code></pre><h3 id="关闭开启的selinux，并安装docker-ce-17-03-1-ce"><a href="#关闭开启的selinux，并安装docker-ce-17-03-1-ce" class="headerlink" title="关闭开启的selinux，并安装docker-ce-17.03.1.ce"></a>关闭开启的selinux，并安装docker-ce-17.03.1.ce</h3><pre><code>$ yum -y install docker-ce-17.03.1.ce
$ docker version   # 查看docker版本信息
</code></pre><h3 id="Docker使用overlay2"><a href="#Docker使用overlay2" class="headerlink" title="Docker使用overlay2"></a>Docker使用overlay2</h3><pre><code>$ lsmod |grep overlay   # 检查overlay是否存在
$ modprobe overlay     #  加载overlay模块
$ mkdir /etc/docker
$ vi /etc/docker/daemon.json  # 修改存储引擎为overlay
{
  &quot;storage-driver&quot;: &quot;overlay2&quot;,
  &quot;storage-opts&quot;: [
    &quot;overlay2.override_kernel_check=true&quot;
  ]
}
$ systemctl start docker
$ docker info # 查看docker使用的引擎
</code></pre><h3 id="增加docker-配置"><a href="#增加docker-配置" class="headerlink" title="增加docker 配置"></a>增加docker 配置</h3><pre><code>$ vim  /etc/systemd/system/docker.service

[Unit]
Description=Docker Application Container Engine
Documentation=http://docs.docker.com
After=network.target docker-storage-setup.service
Wants=docker-storage-setup.service

[Service]
Type=notify
Environment=GOTRACEBACK=crash
ExecReload=/bin/kill -s HUP $MAINPID
Delegate=yes
KillMode=process
ExecStart=/usr/bin/dockerd \
          $DOCKER_OPTS \
          $DOCKER_STORAGE_OPTIONS \
          $DOCKER_NETWORK_OPTIONS \
          $DOCKER_DNS_OPTIONS \
          $INSECURE_REGISTRY
LimitNOFILE=1048576
LimitNPROC=1048576
LimitCORE=infinity
TimeoutStartSec=1min
Restart=on-abnormal
[Install]
WantedBy=multi-user.target

$ mkdir -p /etc/systemd/system/docker.service.d   # 后续还需要增加的配置放置目录
$ vi /etc/systemd/system/docker.service.d/docker-dns.conf  # 增加docker的dns配置,后续配置好dns再增加
$ vi /etc/systemd/system/docker.service.d/docker-options.conf  # 后续再这个配置文件中加入私有仓库信息配置
[Service]
Environment=&quot;DOCKER_OPTS=  --graph=/opt/docker --log-opt max-size=50m --log-opt max-file=5&quot;
</code></pre><h3 id="重新读取配置，启动-docker"><a href="#重新读取配置，启动-docker" class="headerlink" title="重新读取配置，启动 docker"></a>重新读取配置，启动 docker</h3><pre><code>$ systemctl daemon-reload
$ systemctl start docker
$ systemctl enable docker
$ journalctl -f -t docker  和 journalctl -u docker # 定位问题日志
</code></pre><h2 id="安装私有仓库-Registry"><a href="#安装私有仓库-Registry" class="headerlink" title="安装私有仓库 Registry"></a>安装私有仓库 Registry</h2><table><tr><td bgcolor="#008000"> master </td></tr></table>

<h3 id="运行Registry容器"><a href="#运行Registry容器" class="headerlink" title="运行Registry容器"></a>运行Registry容器</h3><pre><code>$ mkdir -p /opt/docker-data/repos     # 创建registry的挂载目录
$ docker run -d -p 8001:5000 --restart=always --privileged --name registry -v /opt/docker-data/repos:/var/lib/registry registry:2.6    # 运行registry最新容器
</code></pre><p><strong>参数说明：</strong></p>
<ul>
<li>-d表示守护进程，-p表示本地的8001端口映射到容器的5000端口， restart表示容器挂了是否自启， -v表示本地的目录映射到容器的目录</li>
<li>–privileged 使用该参数，container内的root拥有真正的root权限。否则container内的root只是外部的一个普通用户权限。privileged启动的容器，可以看到很多host上的设备，并且可以执行mount。甚至允许你在docker容器中启动docker容器。</li>
</ul>
<h3 id="测试可用性"><a href="#测试可用性" class="headerlink" title="测试可用性"></a>测试可用性</h3><pre><code>$ docker pull  index.tenxcloud.com/google_containers/pause:3.0  # 拉取一个镜像做测试
$ docker tag index.tenxcloud.com/google_containers/pause:3.0  k8s-master01:8001/google_containers/pause:3.0  # 改为本地镜像的存储名(镜像仓库地址:/项目地址/镜像名:版本号)
$ docker push k8s-master01:8001/google_containers/pause:3.0 # 推送到本地镜像仓库
</code></pre><h3 id="master和node-都需要修改的docker关于registry的配置"><a href="#master和node-都需要修改的docker关于registry的配置" class="headerlink" title="master和node 都需要修改的docker关于registry的配置"></a>master和node 都需要修改的docker关于registry的配置</h3><pre><code>$ vi /etc/systemd/system/docker.service.d/docker-options.conf  # 增加私有仓库地址的配置
[Service]
Environment=&quot;DOCKER_OPTS=--insecure-registry=k8s-master01:8001 \
--graph=/opt/docker --log-opt max-size=50m --log-opt max-file=5&quot;
$ systemctl daemon-reload   # 重启加载配置
$ systemctl restart docker
$ k8s-master01:8001/google_containers/pause:3.0    # node 节点测试一下是否可以拉取镜像
</code></pre><h2 id="安装cfssl并创建CA"><a href="#安装cfssl并创建CA" class="headerlink" title="安装cfssl并创建CA"></a>安装cfssl并创建CA</h2><table><tr><td bgcolor="#008000"> master </td></tr></table>

<h3 id="安装-cfssl"><a href="#安装-cfssl" class="headerlink" title="安装 cfssl"></a>安装 cfssl</h3><pre><code>$ mkdir /opt/tools/cfssl -p
$ cd /opt/tools/cfssl
$ wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
$ wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
$ wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
$ mv cfssl_linux-amd64 cfssl
$ mv cfssljson_linux-amd64 cfssljson
$ mv cfssl-certinfo_linux-amd64 cfssl-certinfo
$ chmod +x *
$ mv cfssl/* /usr/local/bin
</code></pre><h3 id="创建-CA-证书配置"><a href="#创建-CA-证书配置" class="headerlink" title="创建 CA 证书配置"></a>创建 CA 证书配置</h3><pre><code>$ mkdir /opt/ssl
$ cd /opt/ssl
$  vi csr.json
{
  &quot;CN&quot;: &quot;kubernetes&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;GuangZhou&quot;,
      &quot;L&quot;: &quot;GuangZhou&quot;,
      &quot;O&quot;: &quot;k8s&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ],
  &quot;ca&quot;: {
      &quot;expiry&quot;: &quot;262880h&quot;
  }
}
</code></pre><p><strong><em>这里的CA证书期限很多教程都是一个炕，应该如上配置才是正确的，不然都是5年期限！</em></strong></p>
<h3 id="生成-CA-证书和私钥"><a href="#生成-CA-证书和私钥" class="headerlink" title="生成 CA 证书和私钥"></a>生成 CA 证书和私钥</h3><pre><code>$ cd /opt/ssl/
$ cfssl  gencert -initca csr.json | cfssljson -bare ca
$ ls -l
ca.csr          # 证书请求文件
ca-key.pem  # ca私钥
ca.pem    # ca证书
csr.json
config.json
</code></pre><p><strong><em>注意： 将会生成 ca-key.pem，ca.csr，ca.pem 这三个文件，请务必保证 ca-key.pem 文件的安全，</em>.csr 文件在整个过程中不会使用。*</strong></p>
<h3 id="分发证书"><a href="#分发证书" class="headerlink" title="分发证书"></a>分发证书</h3><table><tr><td bgcolor="#008000"> master和node </td></tr></table>

<pre><code>$ mkdir -p /etc/kubernetes/ssl  # 创建证书目录
$ cp *.pem /etc/kubernetes/ssl  # 拷贝所有文件到目录下
$ cp ca.csr /etc/kubernetes/ssl
$  ls /etc/kubernetes/ssl
ca.csr  ca-key.pem  ca.pem
$ scp -a /etc/kubernetes/ssl/*  root@k8s-node01: /etc/kubernetes/ssl
$ scp -a /etc/kubernetes/ssl/*  root@k8s-node02: /etc/kubernetes/ssl
</code></pre><h2 id="etcd-集群"><a href="#etcd-集群" class="headerlink" title="etcd 集群"></a>etcd 集群</h2><blockquote>
<p>etcd是k8s非常重要的组件，因此这里采用etcd集群，三个节点都安装etcd，etcd开选举模式。</p>
</blockquote>
<h3 id="安装-etcd"><a href="#安装-etcd" class="headerlink" title="安装 etcd"></a>安装 etcd</h3><pre><code>$ cd /opt/tools
$ wget https://github.com/coreos/etcd/releases/download/v3.2.14/etcd-v3.2.14-linux-amd64.tar.gz
$ tar zxvf etcd-v3.2.14-linux-amd64.tar.gz
$ cd etcd-v3.2.14-linux-amd64
$ mv etcd  etcdctl /usr/bin/
$ scp /usr/bin/etcd*  root@k8s-node01:/usr/bin/
$ scp /usr/bin/etcd* root@k8s-node02:/usr/bin/
</code></pre><h3 id="创建-etcd-证书"><a href="#创建-etcd-证书" class="headerlink" title="创建 etcd 证书"></a>创建 etcd 证书</h3><pre><code>$ cd /opt/ssl/
$ vi etcd-csr.json  # 创建etcd的证书请求配置
{
  &quot;CN&quot;: &quot;etcd&quot;,
  &quot;hosts&quot;: [
    &quot;127.0.0.1&quot;,
    &quot;10.173.36.214&quot;,
    &quot;10.173.36.215&quot;,
    &quot;10.173.36.216&quot;
  ],
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;GuangZhou&quot;,
      &quot;L&quot;: &quot;GuangZhou&quot;,
      &quot;O&quot;: &quot;k8s&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ]
}


$ vim config.json
{
  &quot;signing&quot;: {
       &quot;default&quot;: {
        &quot;expiry&quot;: &quot;87600h&quot;
    },
    &quot;profiles&quot;: {
      &quot;kubernetes&quot;: {
        &quot;usages&quot;: [
            &quot;signing&quot;,
            &quot;key encipherment&quot;,
            &quot;server auth&quot;,
            &quot;client auth&quot;
        ],
        &quot;expiry&quot;: &quot;87600h&quot;
       }
     }
   }
}
</code></pre><p><strong><em>注意：上面的证书请求配置，不能使用hostname,要使用ip,建议多预留几个IP。</em></strong></p>
<pre><code>$ cfssl gencert -ca=/opt/ssl/ca.pem \
  -ca-key=/opt/ssl/ca-key.pem \
  -config=/opt/ssl/config.json \
  -profile=kubernetes etcd-csr.json | cfssljson -bare etcd

$ ls etcd*.pem # 生成etcd的证书和私钥
etcd-key.pem  # etcd私钥
etcd.pem       # etcd证书
</code></pre><h3 id="etcd证书分发-三个节点均为etcd"><a href="#etcd证书分发-三个节点均为etcd" class="headerlink" title="etcd证书分发(三个节点均为etcd)"></a>etcd证书分发(三个节点均为etcd)</h3><pre><code>$ cp -a etcd*.pem /etc/kubernetes/ssl          # etcd1
$ scp -p etcd*.pem root@k8s-node01:/etc/kubernetes/ssl    # etcd2
$ scp -p etcd*.pem root@k8s-node02:/etc/kubernetes/ssl    # etcd3
</code></pre><h3 id="增加etcd-配置"><a href="#增加etcd-配置" class="headerlink" title="增加etcd 配置"></a>增加etcd 配置</h3><table><tr><td bgcolor="#008000"> master和node </td></tr></table>

<pre><code>$ mkdir /opt/etcd
$ vi /etc/systemd/system/etcd.service     # etcd1
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
WorkingDirectory=/opt/etcd/
User=root
ExecStart=/usr/bin/etcd \
  --name=etcd1 \
  --cert-file=/etc/kubernetes/ssl/etcd.pem \
  --key-file=/etc/kubernetes/ssl/etcd-key.pem \
  --peer-cert-file=/etc/kubernetes/ssl/etcd.pem \
  --peer-key-file=/etc/kubernetes/ssl/etcd-key.pem \
  --trusted-ca-file=/etc/kubernetes/ssl/ca.pem \
  --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem \
  --initial-advertise-peer-urls=https://10.173.36.214:2380 \
  --listen-peer-urls=https://10.173.36.214:2380 \
  --listen-client-urls=https://10.173.36.214:2379,http://127.0.0.1:2379 \
  --advertise-client-urls=https://10.173.36.214:2379 \
  --initial-cluster-token=k8s-etcd-cluster \
  --initial-cluster=etcd1=https://10.173.36.214:2380,etcd2=https://10.173.36.216:2380,etcd3=https://10.173.36.215:2380 \
  --initial-cluster-state=new \
  --data-dir=/opt/etcd/
Restart=on-failure
RestartSec=5
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target


$ mkdir /opt/etcd
$ vi /etc/systemd/system/etcd.service  # etcd2
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
WorkingDirectory=/opt/etcd/
User=root
ExecStart=/usr/bin/etcd \
  --name=etcd2 \
  --cert-file=/etc/kubernetes/ssl/etcd.pem \
  --key-file=/etc/kubernetes/ssl/etcd-key.pem \
  --peer-cert-file=/etc/kubernetes/ssl/etcd.pem \
  --peer-key-file=/etc/kubernetes/ssl/etcd-key.pem \
  --trusted-ca-file=/etc/kubernetes/ssl/ca.pem \
  --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem \
  --initial-advertise-peer-urls=https://10.173.36.216:2380 \
  --listen-peer-urls=https://10.173.36.216:2380 \
  --listen-client-urls=https://10.173.36.216:2379,http://127.0.0.1:2379 \
  --advertise-client-urls=https://10.173.36.216:2379 \
  --initial-cluster-token=k8s-etcd-cluster \
  --initial-cluster=etcd1=https://10.173.36.214:2380,etcd2=https://10.173.36.216:2380,etcd3=https://10.173.36.215:2380 \
  --initial-cluster-state=new \
  --data-dir=/opt/etcd/
Restart=on-failure
RestartSec=5
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target


$ mkdir /opt/etcd
$ vi /etc/systemd/system/etcd.service   # etcd3

[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
WorkingDirectory=/opt/etcd/
User=root
ExecStart=/usr/bin/etcd \
  --name=etcd3 \
  --cert-file=/etc/kubernetes/ssl/etcd.pem \
  --key-file=/etc/kubernetes/ssl/etcd-key.pem \
  --peer-cert-file=/etc/kubernetes/ssl/etcd.pem \
  --peer-key-file=/etc/kubernetes/ssl/etcd-key.pem \
  --trusted-ca-file=/etc/kubernetes/ssl/ca.pem \
  --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem \
  --initial-advertise-peer-urls=https://10.173.36.215:2380 \
  --listen-peer-urls=https://10.173.36.215:2380 \
  --listen-client-urls=https://10.173.36.215:2379,http://127.0.0.1:2379 \
  --advertise-client-urls=https://10.173.36.215:2379 \
  --initial-cluster-token=k8s-etcd-cluster \
  --initial-cluster=etcd1=https://10.173.36.214:2380,etcd2=https://10.173.36.216:2380,etcd3=https://10.173.36.215:2380 \
  --initial-cluster-state=new \
  --data-dir=/opt/etcd/
Restart=on-failure
RestartSec=5
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
</code></pre><h3 id="启动etcd"><a href="#启动etcd" class="headerlink" title="启动etcd"></a>启动etcd</h3><pre><code>$ systemctl daemon-reload
$ systemctl enable etcd
$ systemctl start etcd
$ systemctl status etcd
</code></pre><h3 id="验证-etcd-集群状态"><a href="#验证-etcd-集群状态" class="headerlink" title="验证 etcd 集群状态"></a>验证 etcd 集群状态</h3><p><strong>查看集群状态：</strong></p>
<pre><code>$ etcdctl --endpoints=https://10.173.36.214:2379,https://10.173.36.215:2379,https://10.173.36.216:2379\
        --cert-file=/etc/kubernetes/ssl/etcd.pem \
        --ca-file=/etc/kubernetes/ssl/ca.pem \
        --key-file=/etc/kubernetes/ssl/etcd-key.pem \
        cluster-health
member 3f2cd58f2041fd0c is healthy: got healthy result from https://10.173.36.215:2379
member 81779624411cd53c is healthy: got healthy result from https://10.173.36.216:2379
member 87fb8e044eab3dee is healthy: got healthy result from https://10.173.36.214:2379
</code></pre><p><strong>查看集群成员:</strong><br>可以看到集群节点的选举情况</p>
<pre><code>$ etcdctl --endpoints=https://10.173.36.214:2379,https://10.173.36.215:2379,https://10.173.36.216:2379\
        --cert-file=/etc/kubernetes/ssl/etcd.pem \
        --ca-file=/etc/kubernetes/ssl/ca.pem \
        --key-file=/etc/kubernetes/ssl/etcd-key.pem \
        member list
3f2cd58f2041fd0c: name=etcd3 peerURLs=https://10.173.36.215:2380 clientURLs=https://10.173.36.215:2379 isLeader=false
81779624411cd53c: name=etcd2 peerURLs=https://10.173.36.216:2380 clientURLs=https://10.173.36.216:2379 isLeader=true   // 被选中
87fb8e044eab3dee: name=etcd1 peerURLs=https://10.173.36.214:2380 clientURLs=https://10.173.36.214:2379 isLeader=false
</code></pre><p><strong>etcd查看报错:</strong></p>
<pre><code>$ journalctl -f -t etcd
</code></pre><h2 id="Kubernetes-集群（Master）"><a href="#Kubernetes-集群（Master）" class="headerlink" title="Kubernetes 集群（Master）"></a>Kubernetes 集群（Master）</h2><blockquote>
<p>kubectl 安装在所有需要进行操作的机器上,一般放在master节点上；Master 需要部署 kube-apiserver , kube-scheduler , kube-controller-manager 这三个组件。Node需要部署kubelet,kubeproxy这两个组件。</p>
</blockquote>
<table><tr><td bgcolor="#008000"> master </td></tr></table>

<h3 id="安装kubernetes组件"><a href="#安装kubernetes组件" class="headerlink" title="安装kubernetes组件"></a>安装kubernetes组件</h3><pre><code>$ cd /opt/tools
$ wget https://dl.k8s.io/v1.9.1/kubernetes-server-linux-amd64.tar.gz
$ tar -xzvf kubernetes-server-linux-amd64.tar.gz
$ cd kubernetes
$ cp -r server/bin/{kube-apiserver,kube-controller-manager,kube-scheduler,kubectl} /usr/local/bin
$ scp -r server/bin/{kube-apiserver,kube-controller-manager,kube-scheduler,kubectl,kube-proxy,kubelet} k8s-node01:/usr/local/bin
$ scp -r server/bin/{kubelet,kube-proxy} k8s-node02:/usr/local/bin
</code></pre><h3 id="kubeclt"><a href="#kubeclt" class="headerlink" title="kubeclt"></a>kubeclt</h3><h4 id="创建-admin-证书-client证书"><a href="#创建-admin-证书-client证书" class="headerlink" title="创建 admin 证书(client证书)"></a>创建 admin 证书(client证书)</h4><blockquote>
<p>kubectl的客户端证书，用于kubectl 与 kube-apiserver 的安全端口通信，需要为安全通信提供 TLS 证书和秘钥。</p>
</blockquote>
<pre><code>$ cd /opt/ssl/
$ vim  admin-csr.json #  证书请求配置
{
  &quot;CN&quot;: &quot;admin&quot;,
  &quot;hosts&quot;: [],
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;GuangZhou&quot;,
      &quot;L&quot;: &quot;GuangZhou&quot;,
      &quot;O&quot;: &quot;system:masters&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ]
}

$ cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem -ca-key=/etc/kubernetes/ssl/ca-key.pem -config=/opt/ssl/config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin  # 生成admin证书

$ ls admin* # 查看证书和私钥的生成
admin.csr  admin-csr.json  admin-key.pem  admin.pem

$ cp admin*.pem /etc/kubernetes/ssl/
$ scp -r admin*.pem  k8s-node01:/etc/kubernetes/ssl/  # 实际上这一步可以不做,拷贝后续的 kubectl kubeconfig文件即可！！
</code></pre><h4 id="配置-kubectl-kubeconfig-文件"><a href="#配置-kubectl-kubeconfig-文件" class="headerlink" title="配置 kubectl kubeconfig 文件"></a>配置 kubectl kubeconfig 文件</h4><blockquote>
<p>生成证书相关的配置文件存储与 /root/.kube 目录中,这里的kubectl与apiserver通信，都是nginx-proxy将通过本地的16443转发到集群apiserver的6443端口。</p>
</blockquote>
<pre><code>$ kubectl config set-cluster kubernetes   \
   --certificate-authority=/etc/kubernetes/ssl/ca.pem   --embed-certs=true   --server=https://127.0.0.1:16443
$ kubectl config set-credentials admin   \
   --client-certificate=/etc/kubernetes/ssl/admin.pem   --embed-certs=true   --client-key=/etc/kubernetes/ssl/admin-key.pem
$ kubectl config set-context kubernetes  \
 --cluster=kubernetes   --user=admin
$ kubectl config use-context kubernetes
$ scp -a /root/.kube/config root@k8s-node01:/root/.kube # 要保证k8s-node01上存在/root/.kube目录
</code></pre><p><strong><em>注意：上面的步骤会生成在/root/.kube/下生成一个config文件,将这个config文件拷贝到安装kubectl节点上即可！！！</em></strong></p>
<h3 id="kube-apiserver"><a href="#kube-apiserver" class="headerlink" title="kube-apiserver"></a>kube-apiserver</h3><h4 id="创建-kubernetes-证书（server端"><a href="#创建-kubernetes-证书（server端" class="headerlink" title="创建 kubernetes 证书（server端)"></a>创建 kubernetes 证书（server端)</h4><blockquote>
<p>kube-apiserver的服务端证书，无论是kubectl,kubelet,kube-proxy的客户端证书，都需要跟此证书进行双向的TLS通信！</p>
</blockquote>
<pre><code>$ cd /opt/ssl
$ vi kubernetes-csr.json # 生成证书请求配置
{
  &quot;CN&quot;: &quot;kubernetes&quot;,
  &quot;hosts&quot;: [
    &quot;127.0.0.1&quot;,
    &quot;10.173.36.214&quot;,
    &quot;10.173.36.216&quot;,
    &quot;10.254.0.1&quot;,
    &quot;kubernetes&quot;,
    &quot;kubernetes.default&quot;,
    &quot;kubernetes.default.svc&quot;,
    &quot;kubernetes.default.svc.cluster&quot;,
    &quot;kubernetes.default.svc.cluster.local&quot;
  ],
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;GuangZhou&quot;,
      &quot;L&quot;: &quot;GuangZhou&quot;,
      &quot;O&quot;: &quot;k8s&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ]
}
</code></pre><p><strong><em>注意： 由于本集群采用HA apiserver方式，所以客户端组件在跟apiserver通信的时候，都是通过nginx-proxy将本地的16443转发到集群的apiserver的6443端口，所以这里的证书请求hosts配置，实际上配置成127.0.0.1即可，加kube-apiserver的ip是为了使连接更灵活，可以不适用nginx-proxy转发。</em></strong></p>
<h4 id="生成-kubernetes-证书和私钥"><a href="#生成-kubernetes-证书和私钥" class="headerlink" title="生成 kubernetes 证书和私钥"></a>生成 kubernetes 证书和私钥</h4><pre><code>$ cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem \
   -ca-key=/etc/kubernetes/ssl/ca-key.pem \
   config=/opt/ssl/config.json \
   -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes

 $ ls -lt kubernetes*
 kubernetes.csr kubernetes-key.pem kubernetes.pem kubernetes-csr.json

 $ cp kubernetes*.pem /etc/kubernetes/ssl/
 $ scp -p  kubernetes*.pem root@k8s-node01:/etc/kubernetes/ssl/ # 拷贝到所有的master节点
</code></pre><h4 id="配置-kube-apiserver"><a href="#配置-kube-apiserver" class="headerlink" title="配置 kube-apiserver"></a>配置 kube-apiserver</h4><blockquote>
<p>kubelet 首次启动时向 kube-apiserver 发送 TLS Bootstrapping 请求，kube-apiserver 验证 kubelet 请求中的 token 是否与它配置的 token 一致，如果一致则自动为 kubelet生成证书和秘钥。TLS bootstrapping 功能就是让 kubelet 先使用一个预定的低权限用户连接到 apiserver，然后向 apiserver 申请证书，kubelet 的证书由 apiserver 动态签署；RBAC判定是否有权限创建CSR请求。</p>
</blockquote>
<pre><code>$ head -c 16 /dev/urandom | od -An -t x | tr -d &apos; &apos;  # 生成 token
a0a5d162e00fff4420406defaae32e17
$ cd /opt/ssl    # 创建 token.csv 文件
a0a5d162e00fff4420406defaae32e17,kubelet-bootstrap,10001,&quot;system:kubelet-bootstrap&quot;
$ cd /etc/kubernetes
$ cat &gt;&gt; audit-policy.yaml &lt;&lt;EOF
# Log all requests at the Metadata level
apiVersion: audit.k8s.io/v1beta1
kind: Policy
rules:
- level: Metadata
EOF

$ cp token.csv /etc/kubernetes
$ scp token.csv root@k8s-node01:/etc/kubernetes/
$ scp audit-policy.yaml root@k8s-node01:/etc/kubernetes   # 拷贝token和审核文件到另外的apiserver上
</code></pre><h4 id="配置-kube-apiserver并启动"><a href="#配置-kube-apiserver并启动" class="headerlink" title="配置 kube-apiserver并启动"></a>配置 kube-apiserver并启动</h4><blockquote>
<p>自定义 系统 service 文件一般存于 /etc/systemd/system/ 下</p>
</blockquote>
<pre><code>$ vim /etc/systemd/system/kube-apiserver.service

[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=network.target

[Service]
User=root
ExecStart=/usr/local/bin/kube-apiserver \
  --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota,NodeRestriction \
  --advertise-address=10.173.36.214 \
  --allow-privileged=true \
  --apiserver-count=3 \
  --audit-policy-file=/etc/kubernetes/audit-policy.yaml \
  --audit-log-maxage=30 \
  --audit-log-maxbackup=3 \
  --audit-log-maxsize=100 \
  --audit-log-path=/var/log/kubernetes/audit.log \
  --authorization-mode=Node,RBAC \
  --bind-address=0.0.0.0 \
  --secure-port=6443 \
  --client-ca-file=/etc/kubernetes/ssl/ca.pem \
  --enable-swagger-ui=true \
  --etcd-cafile=/etc/kubernetes/ssl/ca.pem \
  --etcd-certfile=/etc/kubernetes/ssl/etcd.pem \
  --etcd-keyfile=/etc/kubernetes/ssl/etcd-key.pem \
  --etcd-servers=https://10.173.36.214:2379,https://10.173.36.215:2379,https://10.173.36.216:2379 \
  --event-ttl=1h \
  --kubelet-https=true \
  --insecure-bind-address=127.0.0.1 \
  --insecure-port=8080 \
  --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \
  --service-cluster-ip-range=10.254.0.0/16 \
  --service-node-port-range=30000-32000 \
  --tls-cert-file=/etc/kubernetes/ssl/kubernetes.pem \
  --tls-private-key-file=/etc/kubernetes/ssl/kubernetes-key.pem \
  --enable-bootstrap-token-auth \
  --token-auth-file=/etc/kubernetes/token.csv \
  --v=1
Restart=on-failure
RestartSec=5
Type=notify
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target


$ systemctl daemon-reload
$ systemctl enable kube-apiserver
$ systemctl start kube-apiserver
$ systemctl status kube-apiserver
</code></pre><h3 id="kube-controller-manager"><a href="#kube-controller-manager" class="headerlink" title="kube-controller-manager"></a>kube-controller-manager</h3><h4 id="配置-kube-controller-manager"><a href="#配置-kube-controller-manager" class="headerlink" title="配置 kube-controller-manager"></a>配置 kube-controller-manager</h4><pre><code>$ vi /etc/systemd/system/kube-controller-manager.service
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/GoogleCloudPlatform/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-controller-manager \
  --address=0.0.0.0 \
  --master=http://127.0.0.1:8080 \
  --allocate-node-cidrs=true \
  --service-cluster-ip-range=10.254.0.0/16 \
  --cluster-cidr=10.253.0.0/16 \
  --cluster-name=kubernetes \
  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \
  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \
  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \
  --root-ca-file=/etc/kubernetes/ssl/ca.pem \
  --leader-elect=true \
  --v=1
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
</code></pre><h4 id="启动kube-controller-manager"><a href="#启动kube-controller-manager" class="headerlink" title="启动kube-controller-manager"></a>启动kube-controller-manager</h4><pre><code>$ systemctl daemon-reload
$ systemctl enable kube-controller-manager
$ systemctl start kube-controller-manager
$ systemctl status kube-controller-manager
</code></pre><h3 id="kube-scheduler"><a href="#kube-scheduler" class="headerlink" title="kube-scheduler"></a>kube-scheduler</h3><h4 id="配置-kube-scheduler"><a href="#配置-kube-scheduler" class="headerlink" title="配置 kube-scheduler"></a>配置 kube-scheduler</h4><pre><code>$ vi /etc/systemd/system/kube-scheduler.service
[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/GoogleCloudPlatform/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-scheduler \
  --address=0.0.0.0 \
  --master=http://127.0.0.1:8080 \
  --leader-elect=true \
  --v=1
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
</code></pre><h4 id="启动kube-scheduler"><a href="#启动kube-scheduler" class="headerlink" title="启动kube-scheduler"></a>启动kube-scheduler</h4><pre><code>$ systemctl daemon-reload
$ systemctl enable kube-scheduler
$ systemctl start kube-scheduler
$ systemctl status kube-scheduler
</code></pre><p><strong><em>注意： kube-controller-manager和 kube-scheduler 跟 apiserver 通信都是采用的非安全端口127.0.0.1:8080</em></strong></p>
<h3 id="配置nginx-proxy"><a href="#配置nginx-proxy" class="headerlink" title="配置nginx-proxy"></a>配置nginx-proxy</h3><blockquote>
<p>根据具体需要配置nginx-proxy,我这里所有节点都配置了。</p>
</blockquote>
<table><tr><td bgcolor="#008000"> master和node </td></tr></table>

<h4 id="生成nginx配置文件"><a href="#生成nginx配置文件" class="headerlink" title="生成nginx配置文件"></a>生成nginx配置文件</h4><pre><code>$ docker pull nginx:1.13.7-alpine
$ mkdir -p /etc/nginx
$ cat &lt;&lt; EOF &gt;&gt; /etc/nginx/nginx.conf
error_log stderr notice;

worker_processes auto;
events {
  multi_accept on;
  use epoll;
  worker_connections 1024;
}

stream {
    upstream kube_apiserver {
        least_conn;
        server 10.173.36.214:6443;
        server 10.173.36.216:6443;
    }

    server {
        listen        0.0.0.0:16443;
        proxy_pass    kube_apiserver;
        proxy_timeout 10m;
        proxy_connect_timeout 1s;
    }
}
EOF
$ chmod +r /etc/nginx/nginx.conf
</code></pre><h4 id="启动nginx-proxy"><a href="#启动nginx-proxy" class="headerlink" title="启动nginx-proxy"></a>启动nginx-proxy</h4><pre><code>$ cat &lt;&lt; EOF &gt;&gt; /etc/systemd/system/nginx-proxy.service # 配置 Nginx 基于 docker 进程，然后配置 systemd 来启动

[Unit]
Description=kubernetes apiserver docker wrapper
Wants=docker.socket
After=docker.service

[Service]
User=root
PermissionsStartOnly=true
ExecStart=/usr/bin/docker run -p 127.0.0.1:16443:16443 \\
                              -v /etc/nginx:/etc/nginx \\
                              --name nginx-proxy \\
                              --net=host \\
                              --restart=on-failure:5 \\
                              --memory=512M \\
                              nginx:1.13.7-alpine
ExecStartPre=-/usr/bin/docker rm -f nginx-proxy
ExecStop=/usr/bin/docker stop nginx-proxy
Restart=always
RestartSec=15s
TimeoutStartSec=30s

[Install]
WantedBy=multi-user.target
EOF


$ systemctl daemon-reload
$ systemctl start nginx-proxy
$ systemctl enable nginx-proxy
$ systemctl status nginx-proxy
</code></pre><h3 id="查看集群信息"><a href="#查看集群信息" class="headerlink" title="查看集群信息"></a>查看集群信息</h3><h4 id="查看各组件信息"><a href="#查看各组件信息" class="headerlink" title="查看各组件信息"></a>查看各组件信息</h4><pre><code>$ kubectl get componentstatuses  # 查看各组件信息
NAME                 STATUS    MESSAGE              ERROR
controller-manager   Healthy   ok
scheduler            Healthy   ok
etcd-2               Healthy   {&quot;health&quot;: &quot;true&quot;}
etcd-1               Healthy   {&quot;health&quot;: &quot;true&quot;}
etcd-0               Healthy   {&quot;health&quot;: &quot;true&quot;}
</code></pre><h4 id="查看集群状态信息"><a href="#查看集群状态信息" class="headerlink" title="查看集群状态信息"></a>查看集群状态信息</h4><pre><code>$ kubectl cluster-info # 查看集群信息
Kubernetes master is running at https://127.0.0.1:16443
CoreDNS is running at https://127.0.0.1:16443/api/v1/namespaces/kube-system/services/coredns:dns/proxy
kubernetes-dashboard is running at https://127.0.0.1:16443/api/v1/namespaces/kube-system/services/kubernetes-dashboard/proxy
</code></pre><h2 id="Kubernetes-集群（Node）"><a href="#Kubernetes-集群（Node）" class="headerlink" title="Kubernetes 集群（Node）"></a>Kubernetes 集群（Node）</h2><blockquote>
<p>k8s的工作节点只需要运行kubelet及kube-proxy即可，kubelet的证书由Master端自动生成。</p>
<table><tr><td bgcolor="#008000"> master </td></tr></table>

</blockquote>
<h3 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a>kubelet</h3><blockquote>
<p>kubelet 启动时向 kube-apiserver 发送 TLS bootstrapping 请求，需要先将 bootstrap token 文件中的 kubelet-bootstrap 用户赋予 system:node-bootstrapper 角色，然后 kubelet 才有权限创建认证请求(certificatesigningrequests)。</p>
</blockquote>
<h4 id="RBAC授权"><a href="#RBAC授权" class="headerlink" title="RBAC授权"></a>RBAC授权</h4><pre><code>$ kubectl create clusterrolebinding kubelet-bootstrap -- \
clusterrole=system:node-bootstrapper --user=kubelet-bootstrap
</code></pre><p><strong><em>注意：创建一个集群授权用户 kubelet-bootstrap，用户首次与apiserver通信使用！定义了kubelet进程的权限RBAC中用户和资源之间的连接权限。</em></strong></p>
<h4 id="生成bootstrap-kubeconfig配置"><a href="#生成bootstrap-kubeconfig配置" class="headerlink" title="生成bootstrap.kubeconfig配置"></a>生成bootstrap.kubeconfig配置</h4><pre><code>$ kubectl config set-cluster kubernetes \
  --certificate-authority=/etc/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=https://127.0.0.1:16443 \
  --kubeconfig=bootstrap.kubeconfig # 配置集群

$ kubectl config set-credentials kubelet-bootstrap \
  --token=a0a5d162e00fff4420406defaae32e17 \
  --kubeconfig=bootstrap.kubeconfig # 客户端认证
$ kubectl config set-context default \
  --cluster=kubernetes \
  --user=kubelet-bootstrap \
  --kubeconfig=bootstrap.kubeconfig # 配置关联

$ kubectl config use-context default --kubeconfig=bootstrap.kubeconfig # 配置默认关联
mv bootstrap.kubeconfig /etc/kubernetes/
scp -p  /etc/kubernetes/bootstrap.kubeconfig  root@k8s-node02:/etc/kubernetes
</code></pre><p><strong><em>注意：这里生成的bootstrap.kubeconfig非常重要,在 apiserver 配置中指定了一个 token.csv 文件，该文件中是一个预设的用户配置；同时该用户的 Token 和 apiserver 的 CA 证书被写入了 kubelet 所使用的 bootstrap.kubeconfig 配置文件中；这样在首次请求时，kubelet 使用 bootstrap.kubeconfig 中的 apiserver CA 证书来与 apiserver 建立 TLS 通讯，使用 bootstrap.kubeconfig 中的用户 Token 来向 apiserver 声明自己的 RBAC 授权身份</em></strong></p>
<h4 id="创建-kubelet-service-文件"><a href="#创建-kubelet-service-文件" class="headerlink" title="创建 kubelet.service 文件"></a>创建 kubelet.service 文件</h4><table><tr><td bgcolor="#008000"> node </td></tr></table>

<pre><code>$ mkdir /var/lib/kubelet
$ vi /etc/systemd/system/kubelet.service

After=docker.service
Requires=docker.service

[Service]
WorkingDirectory=/var/lib/kubelet
ExecStart=/usr/local/bin/kubelet \
  --cgroup-driver=cgroupfs \
  --hostname-override=k8s-node01 \
  --pod-infra-container-image=k8s-master01:8001/google_containers/pause:3.0 \
  --experimental-bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \
  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \
  --cert-dir=/etc/kubernetes/ssl \
  --cluster_dns=10.254.0.2 \
  --cluster_domain=cluster.local. \
  --hairpin-mode promiscuous-bridge \
  --allow-privileged=true \
  --fail-swap-on=false \
  --serialize-image-pulls=false \
  --logtostderr=true \
  --max-pods=512 \
  --v=1

[Install]
WantedBy=multi-user.target
</code></pre><h4 id="启动kubelet服务"><a href="#启动kubelet服务" class="headerlink" title="启动kubelet服务"></a>启动kubelet服务</h4><pre><code>$ systemctl daemon-reload
$ systemctl enable kubelet
$ systemctl start kubelet # 启动kubelet
$ systemctl status kube
$ journalctl -f -t kubelet  和 journalctl -u kubelet # 定位问题
</code></pre><h4 id="配置-TLS-认证"><a href="#配置-TLS-认证" class="headerlink" title="配置 TLS 认证"></a>配置 TLS 认证</h4><pre><code>$ kubectl get csr # 查看 csr 的名称
$ kubectl get csr | grep Pending | awk &apos;{print $1}&apos; | xargs kubectl certificate approve # 增加 认证
</code></pre><h4 id="验证-nodes"><a href="#验证-nodes" class="headerlink" title="验证 nodes"></a>验证 nodes</h4><pre><code>$ kubectl get nodes
NAME         STATUS    ROLES     AGE       VERSION
k8s-node01   Ready     &lt;none&gt;    6d        v1.9.1
k8s-node02   Ready     &lt;none&gt;    5d        v1.9.1
</code></pre><p><strong><em>注意：成功以后会自动生成配置文件与密钥</em></strong></p>
<pre><code>$ ls /etc/kubernetes/kubelet.kubeconfig
/etc/kubernetes/kubelet.kubeconfig
$ ls /etc/kubernetes/ssl/kubelet* -l
/etc/kubernetes/ssl/kubelet-client.crt
/etc/kubernetes/ssl/kubelet-client.key
/etc/kubernetes/ssl/kubelet.crt
/etc/kubernetes/ssl/kubelet.key
</code></pre><h3 id="配置-kube-proxy"><a href="#配置-kube-proxy" class="headerlink" title="配置 kube-proxy"></a>配置 kube-proxy</h3><blockquote>
<p>证书的生成都是在master节点上完成，然后拷贝到相应的node上</p>
<table><tr><td bgcolor="#008000"> master </td></tr></table>



</blockquote>
<h4 id="生成请求文件"><a href="#生成请求文件" class="headerlink" title="生成请求文件"></a>生成请求文件</h4><pre><code>$ cd /opt/ssl
$ vi kube-proxy-csr.json
{
  &quot;CN&quot;: &quot;system:kube-proxy&quot;,
  &quot;hosts&quot;: [],
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;GuangZhou&quot;,
      &quot;L&quot;: &quot;GuangZhou&quot;,
      &quot;O&quot;: &quot;k8s&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ]
}
</code></pre><h4 id="生成-kube-proxy-证书和私钥"><a href="#生成-kube-proxy-证书和私钥" class="headerlink" title="生成 kube-proxy 证书和私钥"></a>生成 kube-proxy 证书和私钥</h4><pre><code>$ cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem \
-ca-key=/etc/kubernetes/ssl/ca-key.pem \
-config=/opt/ssl/config.json \
-profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy # 生成证书

$ ls kube-proxy*  // 查看生成证书和私钥
kube-proxy.csr  kube-proxy-csr.json  kube-proxy-key.pem  kube-proxy.pem

$ cp kube-proxy* /etc/kubernetes/ssl/ 分发证书及私钥
$ scp kube-proxy* k8s-node01:/etc/kubernetes/ssl/
$ scp kube-proxy* k8s-node02:/etc/kubernetes/ssl/
</code></pre><h4 id="创建-kube-proxy-kubeconfig-文件"><a href="#创建-kube-proxy-kubeconfig-文件" class="headerlink" title="创建 kube-proxy kubeconfig 文件"></a>创建 kube-proxy kubeconfig 文件</h4><pre><code>$ kubectl config set-cluster kubernetes \
   --certificate-authority=/etc/kubernetes/ssl/ca.pem \
   --embed-certs=true \
  --server=https://127.0.0.1:16443 \
   --kubeconfig=kube-proxy.kubeconfig  # 配置集群




$ kubectl config set-credentials kube-proxy \
  --client-certificate=/etc/kubernetes/ssl/kube-proxy.pem \
  --client-key=/etc/kubernetes/ssl/kube-proxy-key.pem \
  --embed-certs=true \
  --kubeconfig=kube-proxy.kubeconfig # 配置客户端认证



$ kubectl config set-context default \
  --cluster=kubernetes \
  --user=kube-proxy \
  --kubeconfig=kube-proxy.kubeconfig

$ kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig

$ scp kube-proxy.kubeconfig k8s-node01:/etc/kubernetes/ # 分发到node节点
$ scp kube-proxy.kubeconfig k8s-node02:/etc/kubernetes/
</code></pre><h4 id="创建-kube-proxy-service-文件"><a href="#创建-kube-proxy-service-文件" class="headerlink" title="创建 kube-proxy.service 文件"></a>创建 kube-proxy.service 文件</h4><blockquote>
<p>打开 ipvs 需要安装 ipvsadm 软件</p>
</blockquote>
<table><tr><td bgcolor="#008000"> node </td></tr></table>

<pre><code>$ yum install ipvsadm -y
$ yum install ipset -y
$ yum install conntrack -y
$ mkdir -p /var/lib/kube-proxy
$ vi /etc/systemd/system/kube-proxy.service

[Unit]
Description=Kubernetes Kube-Proxy Server
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=network.target

[Service]
WorkingDirectory=/var/lib/kube-proxy
ExecStart=/usr/local/bin/kube-proxy \
  --bind-address=10.173.36.216 \
  --hostname-override=k8s-node01 \
  --cluster-cidr=10.253.0.0/16 \
  --masquerade-all \
  --feature-gates=SupportIPVSProxyMode=true \
  --proxy-mode=ipvs \
  --ipvs-min-sync-period=5s \
  --ipvs-sync-period=5s \
  --ipvs-scheduler=rr \
  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig \
  --logtostderr=true \
  --v=1
Restart=on-failure
RestartSec=5
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
</code></pre><h4 id="启动kube-proxy"><a href="#启动kube-proxy" class="headerlink" title="启动kube-proxy"></a>启动kube-proxy</h4><pre><code>$ systemctl daemon-reload
$ systemctl enable kube-proxy
$ systemctl start kube-proxy # 启动kube-proxy
$ systemctl status kube-proxy
$ journalctl -f -t kube-proxy  和 journalctl -u kube-proxy # 定位问题
</code></pre><h4 id="检查ipvs"><a href="#检查ipvs" class="headerlink" title="检查ipvs"></a>检查ipvs</h4><pre><code>$ ipvsadm -L -n
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.254.0.1:443 rr persistent 10800
  -&gt; 10.173.36.214:6443           Masq    1      1          0
  -&gt; 10.173.36.216:6443           Masq    1      0          0
</code></pre><h2 id="配置-Flannel-网络"><a href="#配置-Flannel-网络" class="headerlink" title="配置 Flannel 网络"></a>配置 Flannel 网络</h2><blockquote>
<p>配置完Flannel网络，会覆盖原来docker0的配置，k8s中所有pods将使用这个网段！</p>
</blockquote>
<table><tr><td bgcolor="#008000"> node 和master</td></tr></table>

<h3 id="下载Flannel包"><a href="#下载Flannel包" class="headerlink" title="下载Flannel包"></a>下载Flannel包</h3><pre><code>$ cd /opt/tools
$ wget https://github.com/coreos/flannel/releases/download/v0.10.0/flannel-v0.10.0-linux-amd64.tar.gz # 拷贝包里面的flanneld 和 mk-docker-opts.sh
$ tar xf  flannel-v0.10.0-linux-amd64.tar.gz
$ cp flanneld  mk-docker-opts.sh /usr/local/bin
$ scp -p mk-docker-opts.sh  mk-docker-opts.sh root@k8s-node02:/usr/local/bin
</code></pre><h3 id="设置集群的网络范围"><a href="#设置集群的网络范围" class="headerlink" title="设置集群的网络范围"></a>设置集群的网络范围</h3><pre><code>$ etcdctl --endpoints=https://10.173.36.214:2379,https://10.173.36.215:2379,\
https://10.173.36.216:2379   --ca-file=/etc/kubernetes/ssl/ca.pem  \
 --cert-file=/etc/kubernetes/ssl/etcd.pem \
 --key-file=/etc/kubernetes/ssl/etcd-key.pem  mkdir /kubernetes/network

$ etcdctl --endpoints=https://10.173.36.214:2379,https://10.173.36.215:2379,\
https://10.173.36.216:2379  --ca-file=/etc/kubernetes/ssl/ca.pem \
  --cert-file=/etc/kubernetes/ssl/etcd.pem  \
  --key-file=/etc/kubernetes/ssl/etcd-key.pem  \
 mk /kubernetes/network/config &apos;{ &quot;Network&quot;: &quot;10.253.0.0/16&quot;, &quot;Backend&quot;: { &quot;Type&quot;: &quot;vxlan&quot;, &quot;VNI&quot;: 1 }}&apos;
</code></pre><h3 id="创建flanneld-service文件"><a href="#创建flanneld-service文件" class="headerlink" title="创建flanneld service文件"></a>创建flanneld service文件</h3><pre><code>$ vim /etc/systemd/system/flanneld.service

[Unit]
Description=Flanneld overlay address etcd agent
After=network.target
After=network-online.target
Wants=network-online.target
After=etcd.service
Before=docker.service
[Service]
Type=notify
ExecStart=/usr/local/bin/flanneld \
-etcd-cafile=/etc/kubernetes/ssl/ca.pem \
-etcd-certfile=/etc/kubernetes/ssl/etcd.pem  \
-etcd-keyfile=/etc/kubernetes/ssl/etcd-key.pem\
-etcd-endpoints=https://10.173.36.216:2379,https://0.173.36.214:2379,https://0.173.36.215:2379 \
-etcd-prefix=/kubernetes/network \
-iface=eth0
ExecStartPost=/usr/local/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker
Restart=on-failure
[Install]
WantedBy=multi-user.target
RequiredBy=docker.service
</code></pre><h3 id="修改dokcer-service文件"><a href="#修改dokcer-service文件" class="headerlink" title="修改dokcer service文件"></a>修改dokcer service文件</h3><blockquote>
<p>还需要关联docker和flanneld配置,并重启机器。</p>
</blockquote>
<pre><code>$ vim /etc/systemd/system/docker.service
EnvironmentFile=/run/flannel/docker # 增加这个参数
$ reboot
</code></pre><p><strong>重启前操作：</strong></p>
<ul>
<li>master01:<br>systemctl  enable etcd  flanneld  kube-apiserver kube-controller-manager kube-scheduler   docker</li>
</ul>
<ul>
<li><p>node01:<br>systemctl enable  kube-apiserver kube-controller-manager kube-scheduler docker etcd flanneld kubelet kube-proxy</p>
</li>
<li><p>node02:<br>systemctl  enable docker  etcd flanneld kubelet kube-proxy   nginx-proxy</p>
</li>
</ul>
<h3 id="验证网络"><a href="#验证网络" class="headerlink" title="验证网络"></a>验证网络</h3><blockquote>
<p>ifconfig  查看  docker0 网络 是否已经更改为配置IP网段</p>
</blockquote>
<pre><code>$ mkdir /opt/build
$ vim nginx.yaml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: nginx-dm
spec:
  replicas: 2
  template:
    metadata:
      labels:
        name: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:alpine
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 80

---

apiVersion: v1
kind: Service
metadata:
  name: nginx-svc
spec:
  ports:
    - port: 80
      targetPort: 80
      protocol: TCP
  selector:
    name: nginx

$ kubectl create -f nginx.yaml
$ kubectl get pods  -o wide
NAME                        READY     STATUS    RESTARTS   AGE       IP            NODE
nginx-dm-84f8f49555-ddn7x   1/1       Running   0          3d        10.253.76.2   k8s-node02
nginx-dm-84f8f49555-sjvbj   1/1       Running   0          3d        10.253.76.5   k8s-node02
$ kubectl get svc  -o wide
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE       SELECTOR
kubernetes   ClusterIP   10.254.0.1      &lt;none&gt;        443/TCP   6d        &lt;none&gt;
nginx-svc    ClusterIP   10.254.173.38   &lt;none&gt;        80/TCP    4d        name=nginx

[root@k8s-node01 ~]# curl 10.254.173.38 # 在安装kube-proxy的节点使用
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><h2 id="配置-CoreDNS"><a href="#配置-CoreDNS" class="headerlink" title="配置 CoreDNS"></a>配置 <a href="https://coredns.io" target="_blank" rel="noopener">CoreDNS</a></h2><h3 id="下载并启动coreDNS-svc"><a href="#下载并启动coreDNS-svc" class="headerlink" title="下载并启动coreDNS svc"></a>下载并启动coreDNS svc</h3><ul>
<li>官方镜像<br>coredns/coredns:1.0.4</li>
<li>我的镜像<br>k8s-master01:8001/coredns:1.0.4</li>
</ul>
<table><tr><td bgcolor="#008000"> master</td></tr></table>

<pre><code>$ docker pull coredns/coredns:1.0.4
$ docker tag coredns/coredns:1.0.4  k8s-master01:8001/coredns:1.0.4
$ docker push  k8s-master01:8001/coredns:1.0.4
$ cd /opt/build
$ vim coredns.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: coredns
  namespace: kube-system
  labels:
      kubernetes.io/cluster-service: &quot;true&quot;
      addonmanager.kubernetes.io/mode: Reconcile
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
    addonmanager.kubernetes.io/mode: Reconcile
  name: system:coredns
rules:
- apiGroups:
  - &quot;&quot;
  resources:
  - endpoints
  - services
  - pods
  - namespaces
  verbs:
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
    addonmanager.kubernetes.io/mode: EnsureExists
  name: system:coredns
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:coredns
subjects:
- kind: ServiceAccount
  name: coredns
  namespace: kube-system
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
  labels:
      addonmanager.kubernetes.io/mode: EnsureExists
data:
  Corefile: |
    .:53 {
        errors
        log stdout
        health
        kubernetes cluster.local 10.254.0.0/16
        prometheus
        proxy . /etc/resolv.conf
        cache 30
    }
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: coredns
  namespace: kube-system
  labels:
    k8s-app: coredns
    kubernetes.io/cluster-service: &quot;true&quot;
    addonmanager.kubernetes.io/mode: Reconcile
    kubernetes.io/name: &quot;CoreDNS&quot;
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: coredns
  template:
    metadata:
      labels:
        k8s-app: coredns
    spec:
      serviceAccountName: coredns
      tolerations:
        - key: node-role.kubernetes.io/master
          effect: NoSchedule
        - key: &quot;CriticalAddonsOnly&quot;
          operator: &quot;Exists&quot;
      containers:
      - name: coredns
        image: k8s-master01:8001/coredns:1.0.4
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 170Mi
          requests:
            cpu: 100m
            memory: 70Mi
        args: [ &quot;-conf&quot;, &quot;/etc/coredns/Corefile&quot; ]
        volumeMounts:
        - name: config-volume
          mountPath: /etc/coredns
        ports:
        - containerPort: 53
          name: dns
          protocol: UDP
        - containerPort: 53
          name: dns-tcp
          protocol: TCP
        - containerPort: 9153
          name: metrics
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 60
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 5
      dnsPolicy: Default
      volumes:
        - name: config-volume
          configMap:
            name: coredns
            items:
            - key: Corefile
              path: Corefile
---
apiVersion: v1
kind: Service
metadata:
  name: coredns
  namespace: kube-system
  labels:
    k8s-app: coredns
    kubernetes.io/cluster-service: &quot;true&quot;
    addonmanager.kubernetes.io/mode: Reconcile
    kubernetes.io/name: &quot;CoreDNS&quot;
spec:
  selector:
    k8s-app: coredns
  clusterIP: 10.254.0.2
  ports:
  - name: dns
    port: 53
    protocol: UDP
  - name: dns-tcp
    port: 53
    protocol: TCP
  - name: metrics
    port: 9153
    protocol: TCP

$ kubectl create -f coredns.yaml
</code></pre><p><strong>配置说明:</strong></p>
<ul>
<li><p>这里 kubernetes cluster.local 为 创建 svc 的 IP 段10.254.0.0/16</p>
</li>
<li><p>clusterIP  为 指定 DNS 的 IP clusterIP: 10.254.0.2</p>
</li>
</ul>
<h3 id="验证-dns-服务"><a href="#验证-dns-服务" class="headerlink" title="验证 dns 服务"></a>验证 dns 服务</h3><p>创建一个 pods 来测试一下 dns</p>
<pre><code>$ vim /opt/build/alpine.yaml
apiVersion: v1
kind: Pod
metadata:
  name: alpine
spec:
  containers:
  - name: alpine
    image: alpine
    command:
    - sh
    - -c
    - while true; do sleep 1; done

$ kubectl exec -it alpine nslookup nginx-svc # 测试解析
nslookup: can&apos;t resolve &apos;(null)&apos;: Name does not resolve

Name:      nginx-svc
Address 1: 10.254.173.38 nginx-svc.default.svc.cluster.local
</code></pre><h2 id="部署-Dashboard和Heapster"><a href="#部署-Dashboard和Heapster" class="headerlink" title="部署  Dashboard和Heapster"></a>部署  Dashboard和Heapster</h2><ul>
<li><a href="gcr.io">官方 google_container地址</a></li>
<li><a href="https://hub.tenxcloud.com/search?q=google_containers&amp;source=tenxcloud" target="_blank" rel="noopener">时速云 google_container 镜像地址</a>   # 当然使用国内镜像更快</li>
</ul>
<h3 id="下载-dashboard和heapster镜像"><a href="#下载-dashboard和heapster镜像" class="headerlink" title="下载 dashboard和heapster镜像"></a>下载 dashboard和heapster镜像</h3><pre><code>$ docker pull index.tenxcloud.com/google_containers/kubernetes-dashboard-amd64:v1.4.0
$ docker pull index.tenxcloud.com/google_containers/heapster:v1.2.0
$ docker tag index.tenxcloud.com/google_containers/kubernetes-dashboard-amd64:v1.4.0 k8s-master01:8001/google_containers/kubernetes-dashboard-amd64:v1.4.0
$ docker tag index.tenxcloud.com/google_containers/heapster:v1.2.0   k8s-master01:8001/google_containers/google_containers/heapster:v1.2.0
$ docker push k8s-master01:8001/google_containers/kubernetes-dashboard-amd64:v1.4.0
$ docker push  k8s-master01:8001/google_containers/google_containers/heapster:v1.2.0
</code></pre><h3 id="启动dashboard应用"><a href="#启动dashboard应用" class="headerlink" title="启动dashboard应用"></a>启动dashboard应用</h3><pre><code>$ vim  dashboard.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kubernetes-dashboard
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: kubernetes-dashboard
  labels:
    k8s-app: kubernetes-dashboard
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: kubernetes-dashboard
  namespace: kube-system
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: kubernetes-dashboard
  namespace: kube-system
  labels:
    k8s-app: kubernetes-dashboard
    kubernetes.io/cluster-service: &quot;true&quot;
    addonmanager.kubernetes.io/mode: Reconcile
spec:
  selector:
    matchLabels:
      k8s-app: kubernetes-dashboard
  template:
    metadata:
      labels:
        k8s-app: kubernetes-dashboard
      annotations:
        scheduler.alpha.kubernetes.io/critical-pod: &apos;&apos;
    spec:
      serviceAccountName: kubernetes-dashboard
      containers:
      - name: kubernetes-dashboard
        image: k8s-master01:8001/google_containers/kubernetes-dashboard-amd64:v1.4.0
        resources:
          limits:
            cpu: 100m
            memory: 300Mi
          requests:
            cpu: 100m
            memory: 100Mi
        ports:
        - containerPort: 9090
        livenessProbe:
          httpGet:
            path: /
            port: 9090
          initialDelaySeconds: 30
          timeoutSeconds: 30
      tolerations:
      - key: &quot;CriticalAddonsOnly&quot;
        operator: &quot;Exists&quot;

$ vim dashboard-svc.yaml
apiVersion: v1
kind: Service
metadata:
  name: kubernetes-dashboard
  namespace: kube-system
  labels:
    k8s-app: kubernetes-dashboard
    kubernetes.io/cluster-service: &quot;true&quot;
    addonmanager.kubernetes.io/mode: Reconcile
spec:
  selector:
    k8s-app: kubernetes-dashboard
  type: NodePort
  ports:
  - port: 9090
    targetPort: 9090
    nodePort: 30001

$ kubectl create -f dashboard.yaml
$ kubectl create -f dashboard-svc.yaml # 转发到node节点的30001
</code></pre><h3 id="启动heapster应用"><a href="#启动heapster应用" class="headerlink" title="启动heapster应用"></a>启动heapster应用</h3><pre><code>$ vim heapster.yaml

apiVersion: v1
kind: ServiceAccount
metadata:
  name: heapster
  namespace: kube-system

---

kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: heapster
subjects:
  - kind: ServiceAccount
    name: heapster
    namespace: kube-system
roleRef:
  kind: ClusterRole
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io

---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: heapster
  namespace: kube-system
spec:
  replicas: 1
  template:
    metadata:
      labels:
        task: monitoring
        k8s-app: heapster
    spec:
      serviceAccountName: heapster
      containers:
      - name: heapster
        image: k8s-master01:8001/google_containers/google_containers/heapster:v1.2.0
        imagePullPolicy: IfNotPresent
        command:
        - /heapster
        - --source=kubernetes:kubernetes:https://kubernetes.default

---
apiVersion: v1
kind: Service
metadata:
  labels:
    task: monitoring
    kubernetes.io/cluster-service: &apos;true&apos;
    kubernetes.io/name: Heapster
  name: heapster
  namespace: kube-system
spec:
  ports:
  - port: 80
    targetPort: 8082
  selector:
    k8s-app: heapster

$ kubectl create -f heapster.yaml
$ kubectl get pods -o wide -n=kube-system
NAME                                   READY     STATUS    RESTARTS   AGE       IP            NODE
coredns-6b59c4cb6d-lt7st               1/1       Running   0          4d        10.253.76.4   k8s-node02
heapster-77dd748d7d-h2g9l              1/1       Running   0          2h        10.253.76.3   k8s-node02
kubernetes-dashboard-654448b8b-78hgh   1/1       Running   0          3h        10.253.14.2   k8s-node01
</code></pre><p>Dashboard 访问地址: <a href="http://10.173.36.216:30001" target="_blank" rel="noopener">http://10.173.36.216:30001</a></p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>打赏2块钱,帮我买杯咖啡,继续创作,谢谢大家！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/weixin.png" alt="陈凡 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/aliyipay.jpg" alt="陈凡 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
    
    <div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">
        -------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------
        </div>
    
</div>
  
  </div> 
    <footer class="post-footer">
      
        <div class="post-tags">
          
         
            <a href="/tags/k8s/" rel="tag"><i class="fa fa-tag"></i>k8s</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/03/14/Python实战之简单爬虫/" rel="next" title="Python实战之简单爬虫">
                <i class="fa fa-chevron-left"></i> Python实战之简单爬虫
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/04/11/python版本管理工具-pyenv/" rel="prev" title="python版本管理工具-pyenv">
                python版本管理工具-pyenv <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_fav">收藏夹</a>
<a class="jiathis_button_copy">复制网址</a>
<a class="jiathis_button_email">邮件</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_douban">豆瓣</a>
<a class="jiathis_button_share">一键分享</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="hypercomments_widget"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/upload/avatar.gif"
                alt="陈凡" />
            
              <p class="site-author-name" itemprop="name">陈凡</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">52</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">29</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/chenfanlinux" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-globe"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:chenfan216@gmail.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-globe"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://weibo.com/3942411590" target="_blank" title="微博">
                    
                      <i class="fa fa-fw fa-globe"></i>微博</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://www.zhihu.com/people/love-hero-80" target="_blank" title="知乎">
                    
                      <i class="fa fa-fw fa-globe"></i>知乎</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#集群环境说明"><span class="nav-number">1.</span> <span class="nav-text">集群环境说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务器信息"><span class="nav-number">1.1.</span> <span class="nav-text">服务器信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群详情"><span class="nav-number">1.2.</span> <span class="nav-text">集群详情</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#网络环境说明"><span class="nav-number">1.3.</span> <span class="nav-text">网络环境说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群拓扑图"><span class="nav-number">1.4.</span> <span class="nav-text">集群拓扑图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集群环境初始化"><span class="nav-number">2.</span> <span class="nav-text">集群环境初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#设置主机名-永久生效）"><span class="nav-number">2.1.</span> <span class="nav-text">设置主机名(永久生效）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置epel7-yum源"><span class="nav-number">2.2.</span> <span class="nav-text">配置epel7 yum源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置ntp时间同步"><span class="nav-number">2.3.</span> <span class="nav-text">配置ntp时间同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置密钥对"><span class="nav-number">2.4.</span> <span class="nav-text">配置密钥对</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改-etc-hosts"><span class="nav-number">2.5.</span> <span class="nav-text">修改/etc/hosts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#打开路由转发"><span class="nav-number">2.6.</span> <span class="nav-text">打开路由转发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭NetworkManager"><span class="nav-number">2.7.</span> <span class="nav-text">关闭NetworkManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭-firewall"><span class="nav-number">2.8.</span> <span class="nav-text">关闭 firewall</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装并配置Docker"><span class="nav-number">3.</span> <span class="nav-text">安装并配置Docker</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装yum管理工具并添加Docker官方源"><span class="nav-number">3.1.</span> <span class="nav-text">安装yum管理工具并添加Docker官方源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看yum版本"><span class="nav-number">3.2.</span> <span class="nav-text">查看yum版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装docker-ce的依赖-docker-ce-selinux"><span class="nav-number">3.3.</span> <span class="nav-text">安装docker-ce的依赖 docker-ce-selinux</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭开启的selinux，并安装docker-ce-17-03-1-ce"><span class="nav-number">3.4.</span> <span class="nav-text">关闭开启的selinux，并安装docker-ce-17.03.1.ce</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker使用overlay2"><span class="nav-number">3.5.</span> <span class="nav-text">Docker使用overlay2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#增加docker-配置"><span class="nav-number">3.6.</span> <span class="nav-text">增加docker 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重新读取配置，启动-docker"><span class="nav-number">3.7.</span> <span class="nav-text">重新读取配置，启动 docker</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装私有仓库-Registry"><span class="nav-number">4.</span> <span class="nav-text">安装私有仓库 Registry</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#运行Registry容器"><span class="nav-number">4.1.</span> <span class="nav-text">运行Registry容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试可用性"><span class="nav-number">4.2.</span> <span class="nav-text">测试可用性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#master和node-都需要修改的docker关于registry的配置"><span class="nav-number">4.3.</span> <span class="nav-text">master和node 都需要修改的docker关于registry的配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装cfssl并创建CA"><span class="nav-number">5.</span> <span class="nav-text">安装cfssl并创建CA</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装-cfssl"><span class="nav-number">5.1.</span> <span class="nav-text">安装 cfssl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-CA-证书配置"><span class="nav-number">5.2.</span> <span class="nav-text">创建 CA 证书配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成-CA-证书和私钥"><span class="nav-number">5.3.</span> <span class="nav-text">生成 CA 证书和私钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分发证书"><span class="nav-number">5.4.</span> <span class="nav-text">分发证书</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcd-集群"><span class="nav-number">6.</span> <span class="nav-text">etcd 集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装-etcd"><span class="nav-number">6.1.</span> <span class="nav-text">安装 etcd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-etcd-证书"><span class="nav-number">6.2.</span> <span class="nav-text">创建 etcd 证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#etcd证书分发-三个节点均为etcd"><span class="nav-number">6.3.</span> <span class="nav-text">etcd证书分发(三个节点均为etcd)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#增加etcd-配置"><span class="nav-number">6.4.</span> <span class="nav-text">增加etcd 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动etcd"><span class="nav-number">6.5.</span> <span class="nav-text">启动etcd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证-etcd-集群状态"><span class="nav-number">6.6.</span> <span class="nav-text">验证 etcd 集群状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes-集群（Master）"><span class="nav-number">7.</span> <span class="nav-text">Kubernetes 集群（Master）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装kubernetes组件"><span class="nav-number">7.1.</span> <span class="nav-text">安装kubernetes组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubeclt"><span class="nav-number">7.2.</span> <span class="nav-text">kubeclt</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建-admin-证书-client证书"><span class="nav-number">7.2.1.</span> <span class="nav-text">创建 admin 证书(client证书)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置-kubectl-kubeconfig-文件"><span class="nav-number">7.2.2.</span> <span class="nav-text">配置 kubectl kubeconfig 文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kube-apiserver"><span class="nav-number">7.3.</span> <span class="nav-text">kube-apiserver</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建-kubernetes-证书（server端"><span class="nav-number">7.3.1.</span> <span class="nav-text">创建 kubernetes 证书（server端)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#生成-kubernetes-证书和私钥"><span class="nav-number">7.3.2.</span> <span class="nav-text">生成 kubernetes 证书和私钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置-kube-apiserver"><span class="nav-number">7.3.3.</span> <span class="nav-text">配置 kube-apiserver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置-kube-apiserver并启动"><span class="nav-number">7.3.4.</span> <span class="nav-text">配置 kube-apiserver并启动</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kube-controller-manager"><span class="nav-number">7.4.</span> <span class="nav-text">kube-controller-manager</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置-kube-controller-manager"><span class="nav-number">7.4.1.</span> <span class="nav-text">配置 kube-controller-manager</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动kube-controller-manager"><span class="nav-number">7.4.2.</span> <span class="nav-text">启动kube-controller-manager</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kube-scheduler"><span class="nav-number">7.5.</span> <span class="nav-text">kube-scheduler</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置-kube-scheduler"><span class="nav-number">7.5.1.</span> <span class="nav-text">配置 kube-scheduler</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动kube-scheduler"><span class="nav-number">7.5.2.</span> <span class="nav-text">启动kube-scheduler</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置nginx-proxy"><span class="nav-number">7.6.</span> <span class="nav-text">配置nginx-proxy</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#生成nginx配置文件"><span class="nav-number">7.6.1.</span> <span class="nav-text">生成nginx配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动nginx-proxy"><span class="nav-number">7.6.2.</span> <span class="nav-text">启动nginx-proxy</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看集群信息"><span class="nav-number">7.7.</span> <span class="nav-text">查看集群信息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#查看各组件信息"><span class="nav-number">7.7.1.</span> <span class="nav-text">查看各组件信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看集群状态信息"><span class="nav-number">7.7.2.</span> <span class="nav-text">查看集群状态信息</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes-集群（Node）"><span class="nav-number">8.</span> <span class="nav-text">Kubernetes 集群（Node）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kubelet"><span class="nav-number">8.1.</span> <span class="nav-text">kubelet</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RBAC授权"><span class="nav-number">8.1.1.</span> <span class="nav-text">RBAC授权</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#生成bootstrap-kubeconfig配置"><span class="nav-number">8.1.2.</span> <span class="nav-text">生成bootstrap.kubeconfig配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建-kubelet-service-文件"><span class="nav-number">8.1.3.</span> <span class="nav-text">创建 kubelet.service 文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动kubelet服务"><span class="nav-number">8.1.4.</span> <span class="nav-text">启动kubelet服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置-TLS-认证"><span class="nav-number">8.1.5.</span> <span class="nav-text">配置 TLS 认证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#验证-nodes"><span class="nav-number">8.1.6.</span> <span class="nav-text">验证 nodes</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置-kube-proxy"><span class="nav-number">8.2.</span> <span class="nav-text">配置 kube-proxy</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#生成请求文件"><span class="nav-number">8.2.1.</span> <span class="nav-text">生成请求文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#生成-kube-proxy-证书和私钥"><span class="nav-number">8.2.2.</span> <span class="nav-text">生成 kube-proxy 证书和私钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建-kube-proxy-kubeconfig-文件"><span class="nav-number">8.2.3.</span> <span class="nav-text">创建 kube-proxy kubeconfig 文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建-kube-proxy-service-文件"><span class="nav-number">8.2.4.</span> <span class="nav-text">创建 kube-proxy.service 文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动kube-proxy"><span class="nav-number">8.2.5.</span> <span class="nav-text">启动kube-proxy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检查ipvs"><span class="nav-number">8.2.6.</span> <span class="nav-text">检查ipvs</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置-Flannel-网络"><span class="nav-number">9.</span> <span class="nav-text">配置 Flannel 网络</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载Flannel包"><span class="nav-number">9.1.</span> <span class="nav-text">下载Flannel包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置集群的网络范围"><span class="nav-number">9.2.</span> <span class="nav-text">设置集群的网络范围</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建flanneld-service文件"><span class="nav-number">9.3.</span> <span class="nav-text">创建flanneld service文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改dokcer-service文件"><span class="nav-number">9.4.</span> <span class="nav-text">修改dokcer service文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证网络"><span class="nav-number">9.5.</span> <span class="nav-text">验证网络</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置-CoreDNS"><span class="nav-number">10.</span> <span class="nav-text">配置 CoreDNS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载并启动coreDNS-svc"><span class="nav-number">10.1.</span> <span class="nav-text">下载并启动coreDNS svc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证-dns-服务"><span class="nav-number">10.2.</span> <span class="nav-text">验证 dns 服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署-Dashboard和Heapster"><span class="nav-number">11.</span> <span class="nav-text">部署  Dashboard和Heapster</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载-dashboard和heapster镜像"><span class="nav-number">11.1.</span> <span class="nav-text">下载 dashboard和heapster镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动dashboard应用"><span class="nav-number">11.2.</span> <span class="nav-text">启动dashboard应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动heapster应用"><span class="nav-number">11.3.</span> <span class="nav-text">启动heapster应用</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      
<script type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?d=ipZXdvME3sKg6viC20OoTCYATcaOJ6SQH2wdaJEUHfc"></script>

<div id="music163player">
  <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=525241230&auto=0&height=66"></iframe>
</div>
      
    </div>
  </aside>


        
      </div>
    </main>
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">陈凡</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">135.6k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div> 



  <span class="post-meta-divider">|</span>



 <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.3</div>





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      本站访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      本站总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	

		<script type="text/javascript">
		_hcwp = window._hcwp || [];

		_hcwp.push({widget:"Bloggerstream", widget_id: 98812, selector:".hc-comment-count", label: "{\%COUNT%\}" });

		
		_hcwp.push({widget:"Stream", widget_id: 98812, xid: "2018/04/06/Kubernetes-1-9-1-HA生产环境实践/"});
		

		(function() {
		if("HC_LOAD_INIT" in window)return;
		HC_LOAD_INIT = true;
		var lang = (navigator.language || navigator.systemLanguage || navigator.userLanguage || "en").substr(0, 2).toLowerCase();
		var hcc = document.createElement("script"); hcc.type = "text/javascript"; hcc.async = true;
		hcc.src = ("https:" == document.location.protocol ? "https" : "http")+"://w.hypercomments.com/widget/hc/98812/"+lang+"/widget.js";
		var s = document.getElementsByTagName("script")[0];
		s.parentNode.insertBefore(hcc, s.nextSibling);
		})();
		</script>

	
















  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.3"></script>



  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  


<!--页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>

<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>  



<!-- 
<script type="text/javascript" color="0,0,255" opacity='0.7' zIndex="-1 count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script> -->


</body>
</html>
